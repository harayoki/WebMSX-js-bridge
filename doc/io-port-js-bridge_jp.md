# IOポートJSブリッジ

## 概要

本ドキュメントでは、**WebMSX** 内で **I/Oポート** を使ってJavaScriptコードとMSX側コードを接続する仕組みを説明します。

通信をMSX標準のI/Oポートアクセスに限定することで、WebMSX上で動作するプログラムがJavaScript経由で外部とやり取りできます。この方針により、Web固有のロジックをエミュレータコアやMSXプログラムに直接埋め込むことを避けます。

この仕組みはデフォルトでは **WebMSXエミュレータ内のみで動作** します。ただし、同じI/Oポートアクセスをフックして処理する実機MSX向けカートリッジを設計すれば、外部ハードウェアの能力次第で実機でも似た概念を実現できます。

長期的な目的は、MSXプログラムのロジックをクリーンかつ移植性の高い状態に保ちつつ、将来の専用ROMカートリッジ実装の余地を残すことです。

---

## 設計哲学

- 通信は **I/Oポート経由のみ** で行う
- MSXプログラムに直接Web APIを公開しない
- JavaScriptはMSX OSの一部ではなく外部環境として扱う
- MSX側コードは正当なZ80/MSXソフトウェアのままにする
- エミュレータ固有の挙動はI/O境界に隔離する

この設計により、エミュレータやMSXソフトへWebアクセスをハードコードすることを避け、将来のハードウェア実装の可能性を維持します。

---

## 通信モデル

- **MSX → JS**
  - MSX側は `OUT` 命令でデータを送信
- **JS → MSX**
  - MSX側は `IN` 命令でデータを受信
- データはバイト列として転送
- より高レベルのプロトコル（長さ付きデータ、コマンド、JSONなど）はこのバイトストリーム上に構築

---

## 実現できる例

### BGM / 効果音再生

- JavaScriptが音声再生（例：MP3、ストリーミング音声）を担当
- MSX側は次のようなコマンドを送る:
  - 再生 / 停止
  - トラックID
  - 音量変更

カートリッジ側での音声処理仕様については [サウンドカートリッジ仕様](sound-cartridge-spec_jp.md) を参照してください。

将来のハードウェア案では、ROMカートリッジが以下を行うことが想定されます:
- 外部にMP3や圧縮音声データを格納
- オンボードチップでデコード
- デコードした音声をMSXの音声出力にミックス

これにより、MSX1クラスのマシンでもリッチなストリーミング音声が可能になります。

---

### Webページ遷移やDOM制御

- JavaScriptがDOM更新やページ遷移を実施
- 典型的な利用例:
  - ゲームクリア時の演出
  - シーン遷移
  - エミュレータキャンバス外のUI更新

MSXプログラムはWeb環境を意識せず、I/O経由でコマンドを出すだけです。

---

### インターネットデータへのアクセス

- JavaScriptがインターネットから動的データを取得
  - API
  - オンラインサービス
  - リモート設定やスコア
- 取得したデータをI/Oブリッジ経由でMSX側へ返送

これにより、MSXソフトは自前のネットワークスタックを持たずに外部データへ反応できます。

---

### タッチやジェスチャ入力

- JavaScriptがスマホ/タブレットの操作を検出
  - タッチ座標
  - スワイプ方向
  - ジェスチャ種別
- イベントをエンコードし、I/Oポート経由でMSXへ送信

MSX側のロジックをシンプルかつデバイス非依存のままに、最新の入力手段を利用できます。

---

## 制限事項

- 専用ハードウェアがない限り、この仕組みはWebMSX内でのみ機能
- 性能はI/Oポーリング頻度とプロトコル設計に依存
- タイミングに厳しい処理はMSX側に残すべき

---

## まとめ

I/OポートJSブリッジは、JavaScriptを統合ランタイムではなく外部周辺機器として扱います。MSX時代のI/Oセマンティクスを尊重することで、移植性とシンプルさ、そして将来の実機ハードウェア実装の可能性を保ちつつ、現代的な機能を提供します。
